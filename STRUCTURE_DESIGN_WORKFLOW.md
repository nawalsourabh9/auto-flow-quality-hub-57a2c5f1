# BDS Management System: Structure, Design, and Task Workflow

## 1. Project Structure

```
├── bun.lockb
├── components.json
├── eslint.config.js
├── index.html
├── package.json
├── postcss.config.js
├── README.md
├── tailwind.config.ts
├── tsconfig.app.json
├── tsconfig.json
├── tsconfig.node.json
├── vite.config.ts
├── public/
│   ├── favicon.ico
│   ├── placeholder.svg
│   ├── robots.txt
│   └── lovable-uploads/
│       └── ...
├── src/
│   ├── App.css
│   ├── App.tsx
│   ├── index.css
│   ├── main.tsx
│   ├── vite-env.d.ts
│   ├── components/
│   │   ├── EmailNotification.tsx
│   │   ├── admin/
│   │   ├── audits/
│   │   ├── auth/
│   │   ├── dashboard/
│   │   ├── documents/
│   │   ├── invite/
│   │   ├── layout/
│   │   ├── notifications/
│   │   ├── organization/
│   │   ├── tasks/
│   │   └── ui/
│   ├── hooks/
│   │   ├── use-auth-session.ts
│   │   ├── use-auth.tsx
│   │   ├── use-countdown.ts
│   │   ├── use-mobile.tsx
│   │   ├── use-notifications.tsx
│   │   ├── use-otp.ts
│   │   ├── use-password-validation.ts
│   │   ├── use-signup-otp.ts
│   │   ├── use-task-document-upload.ts
│   │   ├── use-task-filters.ts
│   │   ├── use-task-operations.ts
│   │   ├── use-tasks.ts
│   │   ├── use-toast.ts
│   │   └── task-operations/
│   │       ├── use-task-create.ts
│   │       ├── use-task-update.ts
│   │       ├── ...
│   ├── integrations/
│   │   └── supabase/
│   ├── lib/
│   │   └── utils.ts
│   ├── pages/
│   │   ├── AcceptInvite.tsx
│   │   ├── Admin.tsx.old
│   │   ├── Analytics.tsx
│   │   ├── Audits.tsx
│   │   ├── ChangePassword.tsx
│   │   ├── CreateAdmin.tsx
│   │   ├── Documents.tsx
│   │   ├── Help.tsx
│   │   ├── Index.tsx
│   │   ├── InviteUser.tsx
│   │   ├── Login.tsx
│   │   ├── NonConformances.tsx
│   │   ├── NotFound.tsx
│   │   ├── Organization.tsx
│   │   ├── Profile.tsx
│   │   ├── ResetPassword.tsx
│   │   ├── Settings.tsx
│   │   ├── Signup.tsx
│   │   ├── Tasks.tsx
│   │   ├── Admin/
│   │   └── Users/
│   ├── providers/
│   │   └── AuthProvider.tsx
│   ├── routes/
│   │   └── AppRoutes.tsx
│   ├── services/
│   │   ├── approval-service.ts
│   │   ├── auth-service.ts
│   │   ├── emailService.ts
│   │   └── emailTemplates.ts
│   ├── types/
│   │   ├── audit.ts
│   │   ├── auth.ts
│   │   ├── document.ts
│   │   ├── nonconformance.ts
│   │   └── task.ts
│   └── utils/
│       └── auth-utils.ts
├── supabase/
│   ├── config.toml
│   ├── functions/
│   ├── migrations/
│   │   ├── 20250401_get_departments.sql
│   │   ├── 20250415_hrone_integration_schema.sql
│   │   ├── 20250417_create_dashboard_report_cron.sql
│   │   └── 20250418_exec_sql_function.sql
```

## 2. Design Overview

### 2.1. Main Modules
- **Authentication**: Handles user login, signup, password management, and session state.
- **Tasks**: Core module for task creation, update, assignment, status tracking. Recurring task generation is handled by a backend process.
- **Documents**: Manages document uploads, revisions, approval workflows, and links to tasks.
- **Organization**: Manages departments, employees, and department heads.
- **Notifications**: Email and in-app notifications for task/document events.
- **Dashboard**: Visualizes key metrics, task status, and document status.
- **Integrations**: Supabase for backend (database, auth, storage, functions).

### 2.2. Key Data Types
- **Task**: Rich object with fields for title, description, department, assignee, priority, due date, status, recurrence (including frequency, start/end dates, and parent relationship), customer info, attachments, approval, and comments.
- **TaskDocument**: Linked to tasks, supports multiple revisions, approval hierarchy, and metadata.
- **TeamMember/Employee**: Used for assignment, permissions, and department management.

### 2.3. Hooks and State Management
- **React Query**: Used for data fetching, caching, and mutation (tasks, employees, documents).
- **Custom Hooks**: Encapsulate logic for task operations (`use-task-create`, `use-task-update`, `use-task-operations`), document upload, filters, and authentication.
- **Dialogs/Modals**: For task creation, editing, status updates, and document management.

## 3. Task Workflow

### 3.1. Task Creation
- User opens the create task dialog (`TaskDialogs` via `useTaskOperations`).
- Fills in task details (title, description, department, assignee, priority, due date, recurrence, attachments, etc.).
- If recurring, the system creates a single parent task. Subsequent instances are generated by a backend process.
- Documents can be uploaded and linked to the task (handled by `useTaskDocumentUpload`).
- Task is saved to the database (Supabase `tasks` table), and documents are processed (with approval hierarchy if needed).
- UI updates via React Query cache invalidation.

### 3.2. Task Update
- User opens the edit dialog for a task.
- Updates fields as needed (status, assignee, due date, comments, etc.).
- If the task is recurring, updates to the parent task are saved. Updates to child instances are handled individually. The backend process generates new instances based on the parent's configuration and the previous instance's completion.
- Document changes (new uploads, revisions) are processed and approval hierarchy updated.
- Changes are saved to the database and UI is refreshed.

### 3.3. Task Status Management
- Statuses: `not-started`, `in-progress`, `completed`, `overdue`.
- Status can be updated via dialogs or quick actions.
- The backend automation process automatically updates task status to `overdue` if the due date passes and the status is not `completed`.
- Comments can be added for status changes.
- Approval status (`pending`, `approved`, `rejected`) is tracked separately.

### 3.4. Document Workflow
- Documents are uploaded per task, with metadata and file type.
- Each document can have multiple revisions (tracked in `document_revisions`).
- Approval hierarchy (initiator, checker, approver) is created for each document.
- Approval status and history are tracked for compliance.

### 3.5. Organization & Permissions
- Departments and employees are managed in the organization module.
- Department heads and roles are tracked for permissions and notifications.
- Permissions are simplified (all users can initiate/check/approve in current setup).

### 3.6. Data Fetching & UI
- All tasks, documents, and employees are fetched from Supabase.
- Data is mapped and enriched (e.g., assignee details, document approval status) before rendering.
- Filtering, searching, and sorting are available for tasks and documents.

## 4. File/Module Responsibilities

- **src/hooks/use-tasks.ts**: Fetches and maps all tasks, employees, documents, and approval data.
- **src/hooks/use-task-operations.ts**: Centralizes all task operations (create, update, delete, status, approval).
- **src/hooks/task-operations/use-task-create.ts**: Handles creation of single tasks and the initial parent recurring task.
- **src/hooks/task-operations/use-task-update.ts**: Handles updating tasks, including the parent recurring task.
- **supabase/migrations/20250611122935_create_recurring_task_automation.sql**: Contains the PostgreSQL function (`public.generate_next_recurring_task_instance`) and `pg_cron` schedule for backend recurring task generation and overdue status updates.
- **src/hooks/use-task-document-upload.ts**: Handles document upload, revision, and approval workflow setup.
- **src/pages/Tasks.tsx**: Main UI for listing, filtering, and managing tasks.
- **src/pages/Documents.tsx**: UI for listing and managing documents and their approval status.
- **src/pages/Organization.tsx**: UI for managing departments and employees.
- **src/types/task.ts**: TypeScript interfaces for tasks, team members, and related entities.

## 5. Database (Supabase)
- **Tables**: `tasks` (includes columns for recurrence: `start_date`, `end_date`, `recurring_parent_id`), `employees`, `documents`, `document_revisions`, `approval_hierarchy`.
- **Functions**: Includes the `public.generate_next_recurring_task_instance` PostgreSQL function for recurring task automation, plus functions for integrations, reporting, etc. (see `supabase/functions/` and `migrations/`).

## 6. Extensibility
- Modular hooks and components allow for easy extension (e.g., new task types, document workflows).
- Supabase functions and migrations support backend logic and schema evolution.

---
This document provides a high-level overview of the structure, design, and working task/document workflow for the BDS Management System. For more details, see the respective source files and README.
